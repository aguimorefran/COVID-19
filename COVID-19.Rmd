---
title: "COVID-19"
author: "Juan Diego Martínez y Fco. Aguilera"
date: "22/3/2020"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

# Librerías:

* **tidyverse** para manipulació y visualización.
* **stringr** para parsear los datos en bruto.
* **lubridate** para trabajar con fechas.
* **ggplot2** para visualización de datos.
* **arules** para reglas de asociación

# Datasets

* **Datadista**: https://github.com/datadista/datasets

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```


```{r}
library(readr)
library(tidyverse)
library(lubridate)
library(stringr)
library(arules)
require(gridExtra)
theme_set(theme_bw())
```


# Situación en España

> "El director general de la Organización Mundial de la Salud (OMS), Tedros Adhanom Ghebreyesus, ha declarado este miércoles que el coronavirus Covid-19 pasa de ser una epidemia a una pandemia."

```{r}
nacional <- read_csv("./datasets/nacional_covid19.csv")
nacional$fecha <- as.Date(nacional$fecha)
```

```{r}
# fases de confinamiento y desescalada

# fase 0 (confimaniento total)
fase0 <- dmy("15/03/2020")

# fase 1 (deporte y paseos de niños)
fase1 <- dmy("2/05/2020")

# desescalada (fase 2 en adelante. Englobo el resto de fases porque en todas se permite socializar)
fase2 <- dmy("18/05/2020")
```

## Vista general

* ¿Cuándo se superan los 1000 casos diarios? ¿Y los 100 fallecidos? 
```{r}
# calculo los casos nuevos de infectados, hospitalizados y fallecidos
nacional <- nacional %>% 
  mutate(casos_nuevos = c(0, diff(casos_total)),
         hospitalizados_nuevos = c(NA, diff(hospitalizados)),
         fallecimientos_nuevos = c(0, diff(fallecimientos)),
         altas_nuevas = c(NA, diff(altas)))

fecha_1000_casos <- nacional %>% 
  filter(casos_nuevos >= 1000) %>% 
  select(fecha, casos_nuevos) %>% 
  head(1) %>% 
  first()
fecha_1000_casos

fecha_100_fallecimientos <- nacional %>% 
  filter(fallecimientos_nuevos >= 100) %>% 
  select(fecha, fallecimientos_nuevos) %>% 
  head(1) %>% 
  first()
fecha_100_fallecimientos

```


```{r, fig.height=5, fig.width=10}
# dia con mas casos nuevos
dia_max <- nacional %>% 
  arrange(-casos_nuevos) %>% 
  head(1) %>% 
  select(fecha, casos_nuevos)

nacional %>% 
  ggplot(aes(x = fecha)) + 
  geom_line(aes(y=casos_nuevos, color = "confirmados"), size = 1.2) + 
  geom_line(aes(y=fallecimientos_nuevos, color = "fallecidos"), size = 1.2) +
  geom_line(aes(y=altas_nuevas, color = "altas médicas"), size = 1.2) +
  
  geom_vline(aes(xintercept = fecha_1000_casos), linetype = "dashed", size = 1) + 
  geom_label(aes(x = fecha_1000_casos, y = +Inf, label = "1000 casos diarios", vjust = 5)) +
  
  theme(legend.title = element_blank(), legend.position = "bottom") + 
  
  annotate("rect", xmin = fase0, xmax = fase1,
           ymin=-Inf, ymax=Inf, fill = "blue", alpha = .1) +
  annotate("rect", xmin = fase1, xmax = fase2,
           ymin=-Inf, ymax=Inf, fill = "orange", alpha = .1) +
  annotate("rect", xmin = fase2, xmax = max(nacional$fecha),
           ymin=-Inf, ymax=Inf, fill = "green", alpha = .1) +
  
  geom_label(aes(x = dia_max$fecha, y = dia_max$casos_nuevos, label = paste(dia_max$fecha, "/", dia_max$casos_nuevos, "casos")), hjust = -.1) +
 
  
  xlab("fecha") + ylab("casos") + 
  labs(title = "Casos de Covid-19 en España", subtitle = "Datos diarios de altas, nuevos confirmados, y fallecidos", caption = "Datos proporcionados por datadista")
```

```{r}
# me quedo con los casos nuevos de cada dia
t <- nacional %>% 
  select(casos_nuevos) %>% 
  na.omit() %>% 
  ts(frequency = 7)
plot(decompose(t))
```
He creado una serie temporal de frecuencia 7 para observar la estacionalidad que vemos en la gráfica anterior.

Podemos observar la tendencia exponencial al principio de la pandemia, y como poco a poco se van reduciendo los nuevos casos.
Tambien observamos una estacionalidad de 7 días. Esto podría darse por no acudir al hospital o médico o la no realización de tests los findes de semana.


## Camas UCI

```{r}
# pacientes en UCI durante la pandemia
uci <- read_csv("datasets/ccaa_covid19_uci.csv")

# camas UCI por CA
uci_camas <- read_csv("datasets/ccaa_camas_uci_2017.csv")
uci_camas <- uci_camas %>%
  rename(ID = cod_ine)

# poblacion (se importa raro y hay que hacer chanchullos)
demo <- read_table2("datasets/poblacion.csv")
demo$Total <- as.numeric(gsub(".", "", demo$Total, fixed = TRUE))
demo <- demo %>% 
  filter(Periodo == 2019) %>% 
  filter(Sexo == "Total") %>% 
  select(ID, CCAA, Total)

# sumo las camas de ceuta melilla y la rioja para que cuadre con el cvs de camas uci y lo añado con id = 21
demo2 <- data.frame(ID = 21,
                    CCAA = "Rioja_Ceuta_Melilla",
                    Total = demo[demo$CCAA == "La_Rioja",]$Total+
                      demo[demo$CCAA == "Ceuta",]$Total+
                      demo[demo$CCAA == "Melilla",]$Total)

# junto demo original con demo2 y quito la rioja
demo <- demo %>% 
  filter(ID != 17) %>% 
  rbind(demo2) %>% 
  filter(!CCAA %in% c("Ceuta", "Melilla"))

uci_camas$ID <- as.numeric(uci_camas$ID)
demo$ID <- as.numeric(demo$ID)

demo <- demo %>% 
  select(ID, CCAA, Total) %>% 
  rename(Total_habitantes = Total)
uci_camas <- uci_camas %>% 
  select(ID, Privados, Públicos, Total) %>% 
  rename(Total_camas = Total)

```


```{r, fig.height=10, fig.width=10}
# camas publicas, totales y privadas por cada mil habitantes
camas_habitantes <- merge(demo, uci_camas, by = "ID")
head(camas_habitantes)

colnames(camas_habitantes) <- tolower(colnames(camas_habitantes))

camas_habitantes <- camas_habitantes %>% 
  mutate(camas_privadas_100000 = as.numeric(format(round((privados/total_habitantes)*100000, 2), nsmall=2))) %>% 
  mutate(camas_publicas_100000 = as.numeric(format(round((públicos/total_habitantes)*100000, 2), nsmall=2))) %>% 
  mutate(total_camas_100000 = as.numeric(format(round((total_camas/total_habitantes)*100000, 2), nsmall=2)))

camas_habitantes %>% 
  select(ccaa, camas_privadas_100000, camas_publicas_100000, total_camas_100000) %>% 
  rename(privadas = camas_privadas_100000,
         publicas = camas_publicas_100000,
         total = total_camas_100000) %>% 
  reshape2::melt(id.vars = "ccaa") %>% 
  rename(tipo_cama = variable) %>% 
  filter(tipo_cama %in% c("privadas", "publicas", "total")) %>% 
  ggplot(aes(x=tipo_cama, y=value, fill = tipo_cama)) +
  geom_bar(stat = "identity", width = 0.75) + 
  facet_wrap(~ ccaa) + 
  labs(title = "Camas UCI por cada 100,000 habitantes",subtitle = "Clasificados por Comunidad Autónoma y si pertenecen a un centro privado o público", caption = "Datos camas UCI de 2019\nDatos proporcionados por datadista") + 
  xlab("") + ylab("Número de camas UCI") + 
  theme(legend.position = "bottom", axis.ticks.x = element_blank(), axis.text.x = element_blank())

```

```{r, fig.height=15, fig.width=10}
p1 <- camas_habitantes %>% 
  select(ccaa, camas_privadas_100000, camas_publicas_100000, total_camas_100000) %>% 
  rename(privadas = camas_privadas_100000,
         publicas = camas_publicas_100000,
         total = total_camas_100000) %>% 
  reshape2::melt(id.vars = "ccaa") %>% 
  rename(tipo_cama = variable) %>%
  filter(tipo_cama == "privadas") %>% 
  ggplot(aes(x = reorder(ccaa, value), y = value)) +
  geom_bar(stat = "identity", width = 0.75, fill = "tomato3") + 
  coord_flip() + 
  labs(title="Camas UCI privadas") + 
  xlab("") + ylab("camas")

p2 <- camas_habitantes %>% 
  select(ccaa, camas_privadas_100000, camas_publicas_100000, total_camas_100000) %>% 
  rename(privadas = camas_privadas_100000,
         publicas = camas_publicas_100000,
         total = total_camas_100000) %>% 
  reshape2::melt(id.vars = "ccaa") %>% 
  rename(tipo_cama = variable) %>%
  filter(tipo_cama == "publicas") %>% 
  ggplot(aes(x = reorder(ccaa, value), y = value)) +
  geom_bar(stat = "identity", width = 0.75, fill = "orange") + 
  coord_flip() + 
  labs(title="Camas UCI públicas") + 
  xlab("") + ylab("camas")

p3 <- camas_habitantes %>% 
  select(ccaa, camas_privadas_100000, camas_publicas_100000, total_camas_100000) %>% 
  rename(privadas = camas_privadas_100000,
         publicas = camas_publicas_100000,
         total = total_camas_100000) %>% 
  reshape2::melt(id.vars = "ccaa") %>% 
  rename(tipo_cama = variable) %>%
  filter(tipo_cama == "total") %>% 
  ggplot(aes(x = reorder(ccaa, value), y = value)) +
  geom_bar(stat = "identity", width = 0.75, fill = "purple") + 
  coord_flip() + 
  labs(title="Camas UCI totales") + 
  xlab("") + ylab("camas")

library(grid)
grid.arrange(p1, p2, p3, top = textGrob("Tipos de cama UCI por Comunidad Autónoma por cada 100,000 habitantes", gp=gpar(fontsize=15)))
```

```{r, fig.height=20, fig.width=10}
# casos uci acumulados
casos_uci_ccaa <- read_csv("datasets/ccaa_covid19_uci_long.csv")
casos_uci_ccaa %>% 
  ggplot(aes(x=fecha, y=total)) +
  geom_line() + 
  facet_wrap(~ CCAA, scales = "free", ncol = 3) + 
  labs(title = "Casos UCI acumulados por Comunidad Autónoma", caption = "Datos ofrecidos por Datadista")
```



## Segundas residencias


## TODO ESPAÑA:

* dias desde ultimo dia con 0 infectados hasta 1000 infectados
* segundas residencias por ccaa
* renta por ccaa
* densidad de poblacion
* tasa recuperacion por ccaa
* arules a todo esto